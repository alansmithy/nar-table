<html>
	<head>
		<title>NAR styled table generator 0.1</title>
		<style>

			text{font-family:'avenir';}
			.title {font-size:10pt;font-weight:900;}
			.source {font-size:6.5pt;font-weight:100;}
			.heading {font-size:8pt;font-weight:900;}
			.row {font-size:8pt;font-weight:100;}

			.frame {stroke-width:0.751pt;stroke:#111111;}
			.divider {stroke-width:0.5pt;stroke:#111111;}

			.rowEven{fill:#fff;}
			.rowOdd{fill:#eee;}

		</style>
		<script src="https://d3js.org/d3.v4.min.js"></script>
	</head>
	<body>
	<script>

		const dataSource = "toys.csv"
		const title = "Lorem ipsum dolor sit amet,|consectetur adipiscing elit. Donec efficitur sodales ligula sagittis volutpat.";
		const source = "New source which will be |linewrapped"
		const footnote = "New footnote";//for no footnote, provide no value i.e. just leave is as 'const footnote//'

		//starting positions for columns
		const colPos = [0,40,110,450];

		const w = 580;//width is constant, you can only set it here
		let h;//will be determined by the rows and will change

		//leading settings
		const titleLeading = 14;
		const rowLeading = 10;

		//margins above and below the table itself
		const margin = {
			top:100,
			bottom:50
		};

		//table cell padding
		const cellPadding = {
			left:4,
			top:10,
			bottom:4
		};

		/*shouldn't need to change much below here*/

		//load data
		d3.csv(dataSource,function(csv){

			//extract column names
			const headings = d3.keys(csv[0]);

			//draw SVG
			const svg = d3.select("body").append("svg")
				.attr("width",w)

			//title
			const titleText = svg.append("text")
				.attr("class","title")

			titleText.selectAll("tspan")
				.data(title.split("|"))
				.enter()
				.append("tspan")
				.text(function(d,i){
					return d;
				})
				.attr("x",0)
				.attr("y",20)
				.attr("dy",function(d,i){
					return i*titleLeading;
				})

			//header information
			const header = svg.append("g")
				.attr("id","header")
				.selectAll("text")
				.data(headings)
				.enter()
				.append("text")
				.attr("x",function(d,i){
					return colPos[i]+cellPadding.left;
				})
				.attr("y",margin.top-cellPadding.bottom)
				.attr("class","heading")
				.text(function(d){return d.toUpperCase()})

			const rows = svg.append("g")
				.attr("id","rows")
				.selectAll("g")
				.data(csv)
				.enter()
				.append("g")
				.attr("id",function(d,i){
					return "row_"+(i+1);
				})
				//need to translate the groups later after we have created the content

			let rowHeights = [];

			//outer loop - execute for every row
			rows.each(function(d,i){

				const currentRow = d3.select(this);
				const rect = currentRow.append("rect")
					.attr("width",w)
					.attr("fill","#eee")
					.attr("class",function(){
						if (isEven(i)){
							return "rowEven";
						}	else	{
							return "rowOdd"
						}
					})
					//places the rect in the background, we set height attributes later once the text has been laid out
			
				//inner loop - execute for each column within each row
				headings.forEach(function(e,j){
					const textContent = currentRow.append("text")
						.attr("id",function(d){
							return "row"+i+"col"+j;
						})
						.attr("class","row")
						.attr("x",colPos[j]+cellPadding.left)
						.attr("y",cellPadding.top)

					const tspans = textContent.selectAll("tspan")
						.data(function(d,i){return d[e].split("|")})
						.enter()
						.append("tspan")
						.text(function(d){return d;})
						.attr("x",colPos[j]+cellPadding.left)
						.attr("dy",rowLeading)
				})//end inner loop (columns)

				//height offset by sum of existing rows
				currentRow.attr("transform",function(){
					return "translate(0,"+((i*(cellPadding.top+cellPadding.bottom))+(margin.top+d3.sum(rowHeights)))+")";
				})

				//add the current row to the collection of row heights 
				rowHeights.push(currentRow.node().getBBox().height);

				rect.attr("height",function(){
					return rowHeights[i]+cellPadding.top+cellPadding.bottom
				})

			})//end outer loop (rows)

			//set the height of the svg element based on the completed table
			svg.attr("height",function(){
				const tableHeight = d3.select("#rows").node().getBBox().height
				return margin.top+margin.bottom+tableHeight
			})

			//horizontal header divider
			svg.append("line")
				.attr("y1",margin.top)
				.attr("y2",margin.top)
				.attr("x2",w)
				.attr("class","divider")

			//add vertical column separators
			svg.append("g").selectAll("line")
				.data(headings)
				.enter()
				.append("line")
				.attr("class","divider")
				.attr("x1",function(d,i){
					return colPos[i];
				})
				.attr("x2",function (d,i){
					return colPos[i];
				})
				.attr("y1",function(){
					const headerHeight = d3.select("#header").node().getBBox().height;
					return margin.top-headerHeight;
				})
				.attr("y2",function(){
					const tableHeight = d3.select("#rows").node().getBBox().height;
					return tableHeight+margin.top;
				})


		})

		function isEven(n) {
			//modulus - the % sign - is the remainder from a division operation
   			return n % 2 == 0;
		}

	</script>
	</body>
</html>