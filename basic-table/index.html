<html>
	<head>
		<title>NAR styled table generator 0.1</title>
		<style>

			text{font-family:'avenir';}
			.title {font-size:10pt;font-weight:900;}
			.source {font-size:6.5pt;font-weight:100;}
			.heading {font-size:8pt;font-weight:900;}
			.row {font-size:8pt;font-weight:100;}

			.frame {stroke-width:0.751pt;stroke:#111111;}
			.divider {stroke-width:0.5pt;stroke:#111111;}

			.rowEven{fill:#fff;}
			.rowOdd{fill:#eee;}

		</style>
		<script src="https://d3js.org/d3.v4.min.js"></script>
	</head>
	<body>
	<script>


		/*
				double deck source
				double deck row 
				detect text/number in columns and format right/center accordingly
				consistent , and .00 for numbers

				italicise after brackets...
				vert dividers flush with last cell

				odd-even shading (last cell grey)

		*/

		const dataSource = "toys.csv"
		const title = "New title";
		const source = "New source"
		const footnote = "New footnote";//for no footnote, provide no value i.e. just leave is as 'let footnote//'

		//starting positions for columns
		const colPos = [0,30,150,450];

		const w = 580;//width is constant, you can only set it here
		let h;//will be determined by the rows and will change

		const margin = {
			top:50,
			bottom:30
		};

		const cellPadding = {
			left:4,
			top:6,
			bottom:7
		};

		d3.csv(dataSource,function(csv){



			//column names
			const headings = d3.keys(csv[0]);


			//work out how tall this svg needs to be
			const nRows = csv.length;
			if (h){}else{
				h = margin.top+margin.bottom+(9+(cellPadding.top+cellPadding.bottom))*(nRows+1)
			}

			//draw SVG
			const svg = d3.select("body").append("svg")
				.attr("width",w)
				.attr("height",h);

			//title
			const titleText = svg.append("text")
				.attr("class","title");

			titleText.selectAll("tspan")
				.data(title.split("|"))
				.enter()
				.append("tspan")
				.text(function(d,i){
					return d;
				})
				.attr("x",0)
				.attr("y",20)
				.attr("dy",function(d,i){
					return i*12
				})

			//source
			svg.append("text")
				.attr("x",function(d){
					if (footnote){
						return w;
					}	else	{
						return 0;
					}
				})
				.attr("y",h-6)
				.attr("text-anchor",function(d){
					if (footnote){
						return "end";
					}	else	{
						return "start";
					}
				})
				.attr("class","source")
				.attr("font-style","italic")
				.text(source)

			if (footnote){
				var footnoteText = svg.append("text")
					.attr("y",h-6)
					.attr("class","source")
					.attr("font-style","italic")
					
					//tspan for each element
					footnoteText.selectAll("tspan")
					.data(footnote.split("|"))
						.enter()
						.append("tspan")
						.text(function(d,i){return d;})
						.attr("x",0)
						.attr("y",20)
						.attr("dy",function(d,i){return i*10;})

					//now translate the group based on it's BBox
					var footH = footnoteText.node().getBBox().height;
					footnoteText.attr("transform","translate(0,"+(h-footH-15)+")")
			}

			//table header/footer lines
			//upper
			svg.append("line")
				.attr("class","frame")
				.attr("y1",1)
				.attr("y2",1)
				.attr("x2",w)
			//lower
			svg.append("line")
				.attr("class","frame")
				.attr("y1",h-2)
				.attr("y2",h-2)
				.attr("x2",w)

			//header information
			const header = svg.append("g")
				.attr("id","header")
				.selectAll("text")
				.data(headings)
				.enter()
				.append("text")
				.attr("x",function(d,i){
					return colPos[i]+cellPadding.left;
				})
				.attr("y",margin.top-cellPadding.bottom)
				.attr("class","heading")
				.text(function(d){return d.toUpperCase()})

			//header divider
			svg.append("line")
				.attr("y1",margin.top)
				.attr("y2",margin.top)
				.attr("x2",w)
				.attr("class","divider")

			//row groups
			const rows = svg.append("g")
				.attr("id","rows")
				.selectAll("g")
				.data(csv)
				.enter()
				.append("g")
				.attr("id",function(d,i){
					return "row_"+(i+1);
				})
				.attr("transform",function(d,i){
					const rowHeight = (9+(cellPadding.top+cellPadding.bottom));
					const yOffset = i*rowHeight;
					return "translate(0,"+(margin.top+yOffset)+")";
				})

			rows.append("rect")
				.attr("width",w)
				.attr("height",(9+(cellPadding.top+cellPadding.bottom)))
				.attr("class",function(d,i){
					if (isEven(i)){
						return "rowEven";
					}	else	{
						return "rowOdd"
					}
				})

			headings.forEach(function(d,i){
				//column dividers
				if (i>0){
					svg.append("line")
						.attr("class","divider")
						.attr("x1",function(){
							return colPos[i]
						})
						.attr("x2",function(){
							return colPos[i]
						})
						.attr("y1",margin.top-cellPadding.bottom-13)
						.attr("y2",h-margin.bottom-cellPadding.bottom-14)
				}

				//create the text in each column - rows means it will do this for every row - 
				rows.append("text")
					.attr("x",function(e){
						return colPos[i]+cellPadding.left
					})
					.attr("class","row")
					.attr("y",(9+cellPadding.top))
					.text(function(e){
						return e[d];
					})
			})
		})

		function isEven(n) {
			//modulus - the % sign - is the remainder from a division operation
   			return n % 2 == 0;
		}

	</script>
	</body>
</html>